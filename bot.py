# bot.py - –ü—Ä–æ—Å—Ç–∏–π –±–æ—Ç —Ç—ñ–ª—å–∫–∏ –∑ –ø–æ–ª—ñ–Ω–≥–æ–º
import logging
import asyncio
import signal
import sys
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    Application, CommandHandler, MessageHandler, ContextTypes, 
    filters, ConversationHandler
)

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –Ü–º–ø–æ—Ä—Ç –º–æ–¥—É–ª—ñ–≤
try:
    from database_postgres import db
    logger.info("‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–∏—Ö")
except ImportError as e:
    logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö: {e}")
    raise

try:
    from config import ADMIN_ID, TOKEN
except ImportError as e:
    logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó: {e}")
    raise

# –°—Ç–∞–Ω–∏ –¥–ª—è ConversationHandler
PROFILE_AGE, PROFILE_GENDER, PROFILE_CITY, PROFILE_SEEKING_GENDER, PROFILE_GOAL, PROFILE_BIO = range(6)

# –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è –±–æ—Ç–∞
application = None

# ==================== –§–£–ù–ö–¶–Ü–á –ü–†–û–§–Ü–õ–Æ ====================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    
    # –î–æ–¥–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –±–∞–∑—É
    success = db.add_user(user.id, user.username, user.first_name)
    
    if success:
        await update.message.reply_text(
            f"üëã –í—ñ—Ç–∞—é, {user.first_name}!\n\n"
            "ü§ñ –Ø - Chatrix Bot, —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –¥–ª—è –∑–Ω–∞–π–æ–º—Å—Ç–≤ —Ç–∞ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è.\n\n"
            "üìù –î–∞–≤–∞–π—Ç–µ —Å—Ç–≤–æ—Ä–∏–º–æ –≤–∞—à –ø—Ä–æ—Ñ—ñ–ª—å, —â–æ–± —ñ–Ω—à—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–≥–ª–∏ –≤–∞—Å –∑–Ω–∞–π—Ç–∏!",
            reply_markup=ReplyKeyboardRemove()
        )
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –ø—Ä–æ—Ñ—ñ–ª—å
        user_data, is_complete = db.get_user_profile(user.id)
        
        if is_complete:
            await show_profile(update, context)
        else:
            await start_profile_creation(update, context)
    else:
        await update.message.reply_text("‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.")

async def start_profile_creation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ—á–∞—Ç–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é"""
    await update.message.reply_text(
        "üìù –î–∞–≤–∞–π—Ç–µ —Å—Ç–≤–æ—Ä–∏–º–æ –≤–∞—à –ø—Ä–æ—Ñ—ñ–ª—å!\n\n"
        "–°–∫—ñ–ª—å–∫–∏ –≤–∞–º —Ä–æ–∫—ñ–≤? (–í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ –≤—ñ–¥ 18 –¥–æ 100)",
        reply_markup=ReplyKeyboardRemove()
    )
    return PROFILE_AGE

async def profile_age(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ –≤—ñ–∫—É"""
    try:
        age = int(update.message.text)
        if age < 18 or age > 100:
            await update.message.reply_text("‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –≤—ñ–∫ –≤—ñ–¥ 18 –¥–æ 100 —Ä–æ–∫—ñ–≤:")
            return PROFILE_AGE
        
        context.user_data['age'] = age
        
        # –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –¥–ª—è –≤–∏–±–æ—Ä—É —Å—Ç–∞—Ç—ñ
        keyboard = [
            ["üë® –ß–æ–ª–æ–≤—ñ–∫", "üë© –ñ—ñ–Ω–∫–∞"],
            ["üö´ –°–∫–∞—Å—É–≤–∞—Ç–∏"]
        ]
        reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        
        await update.message.reply_text(
            "üéØ –í–∞—à–∞ —Å—Ç–∞—Ç—å?",
            reply_markup=reply_markup
        )
        return PROFILE_GENDER
        
    except ValueError:
        await update.message.reply_text("‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –≤—ñ–∫ (—á–∏—Å–ª–æ):")
        return PROFILE_AGE

async def profile_gender(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ —Å—Ç–∞—Ç—ñ"""
    text = update.message.text
    
    if "üë®" in text:
        context.user_data['gender'] = 'male'
    elif "üë©" in text:
        context.user_data['gender'] = 'female'
    elif "üö´" in text:
        await update.message.reply_text("‚ùå –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=ReplyKeyboardRemove())
        return ConversationHandler.END
    else:
        await update.message.reply_text("‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—å –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏:")
        return PROFILE_GENDER
    
    await update.message.reply_text(
        "üèôÔ∏è –í —è–∫–æ–º—É –º—ñ—Å—Ç—ñ –≤–∏ –∂–∏–≤–µ—Ç–µ? (–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∏—ó–≤, –õ—å–≤—ñ–≤, –û–¥–µ—Å–∞)",
        reply_markup=ReplyKeyboardRemove()
    )
    return PROFILE_CITY

async def profile_city(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ –º—ñ—Å—Ç–∞"""
    city = update.message.text.strip()
    
    if len(city) < 2:
        await update.message.reply_text("‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞:")
        return PROFILE_CITY
    
    context.user_data['city'] = city
    
    # –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –¥–ª—è –≤–∏–±–æ—Ä—É –∫–æ–≥–æ —à—É–∫–∞—î
    keyboard = [
        ["üë® –ß–æ–ª–æ–≤—ñ–∫—ñ–≤", "üë© –ñ—ñ–Ω–æ–∫", "üë´ –í—Å—ñ—Ö"],
        ["üö´ –°–∫–∞—Å—É–≤–∞—Ç–∏"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    await update.message.reply_text(
        "üîç –ö–æ–≥–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –∑–Ω–∞–π—Ç–∏?",
        reply_markup=reply_markup
    )
    return PROFILE_SEEKING_GENDER

async def profile_seeking_gender(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ –ø–æ—à—É–∫—É —Å—Ç–∞—Ç—ñ"""
    text = update.message.text
    
    if "üë®" in text:
        context.user_data['seeking_gender'] = 'male'
    elif "üë©" in text:
        context.user_data['seeking_gender'] = 'female'
    elif "üë´" in text:
        context.user_data['seeking_gender'] = 'all'
    elif "üö´" in text:
        await update.message.reply_text("‚ùå –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=ReplyKeyboardRemove())
        return ConversationHandler.END
    else:
        await update.message.reply_text("‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏:")
        return PROFILE_SEEKING_GENDER
    
    # –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –¥–ª—è –≤–∏–±–æ—Ä—É —Ü—ñ–ª—ñ
    keyboard = [
        ["üíï –°–µ—Ä–π–æ–∑–Ω—ñ —Å—Ç–æ—Å—É–Ω–∫–∏", "üë• –î—Ä—É–∂–±–∞", "üí¨ –°–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è"],
        ["üé≠ –§–ª—ñ—Ä—Ç", "üö´ –°–∫–∞—Å—É–≤–∞—Ç–∏"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    await update.message.reply_text(
        "üéØ –Ø–∫–∞ –≤–∞—à–∞ —Ü—ñ–ª—å?",
        reply_markup=reply_markup
    )
    return PROFILE_GOAL

async def profile_goal(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ —Ü—ñ–ª—ñ"""
    text = update.message.text
    
    goal_map = {
        "üíï –°–µ—Ä–π–æ–∑–Ω—ñ —Å—Ç–æ—Å—É–Ω–∫–∏": "–°–µ—Ä–π–æ–∑–Ω—ñ —Å—Ç–æ—Å—É–Ω–∫–∏",
        "üë• –î—Ä—É–∂–±–∞": "–î—Ä—É–∂–±–∞", 
        "üí¨ –°–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è": "–°–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è",
        "üé≠ –§–ª—ñ—Ä—Ç": "–§–ª—ñ—Ä—Ç"
    }
    
    if text in goal_map:
        context.user_data['goal'] = goal_map[text]
    elif "üö´" in text:
        await update.message.reply_text("‚ùå –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ.", reply_markup=ReplyKeyboardRemove())
        return ConversationHandler.END
    else:
        await update.message.reply_text("‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏:")
        return PROFILE_GOAL
    
    await update.message.reply_text(
        "üìñ –†–æ–∑–∫–∞–∂—ñ—Ç—å —Ç—Ä–æ—Ö–∏ –ø—Ä–æ —Å–µ–±–µ:\n"
        "(–í–∞—à—ñ —ñ–Ω—Ç–µ—Ä–µ—Å–∏, —Ö–æ–±—ñ, —â–æ —à—É–∫–∞—î—Ç–µ —Ç–æ—â–æ)\n\n"
        "üí° –ù–∞–ø—Ä–∏–∫–ª–∞–¥: '–õ—é–±–ª—é –ø–æ–¥–æ—Ä–æ–∂—ñ, –∫—ñ–Ω–æ —Ç–∞ –∞–∫—Ç–∏–≤–Ω–∏–π –≤—ñ–¥–ø–æ—á–∏–Ω–æ–∫. –®—É–∫–∞—é —Ü—ñ–∫–∞–≤–∏—Ö —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫—ñ–≤.'",
        reply_markup=ReplyKeyboardRemove()
    )
    return PROFILE_BIO

async def profile_bio(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–∫–∞ –±—ñ–æ"""
    bio = update.message.text.strip()
    
    if len(bio) < 10:
        await update.message.reply_text("‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–ø–∏—à—ñ—Ç—å —Ç—Ä–æ—à–∫–∏ –±—ñ–ª—å—à–µ –ø—Ä–æ —Å–µ–±–µ (–º—ñ–Ω—ñ–º—É–º 10 —Å–∏–º–≤–æ–ª—ñ–≤):")
        return PROFILE_BIO
    
    context.user_data['bio'] = bio
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å –≤ –±–∞–∑—É
    user = update.effective_user
    success = db.update_or_create_user_profile(
        telegram_id=user.id,
        age=context.user_data['age'],
        gender=context.user_data['gender'],
        city=context.user_data['city'],
        seeking_gender=context.user_data['seeking_gender'],
        goal=context.user_data['goal'],
        bio=context.user_data['bio']
    )
    
    if success:
        await update.message.reply_text(
            "üéâ –í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!\n\n"
            "–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ:\n"
            "‚Ä¢ üì± –ü–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –∞–Ω–∫–µ—Ç–∏\n"  
            "‚Ä¢ ‚ù§Ô∏è –°—Ç–∞–≤–∏—Ç–∏ –ª–∞–π–∫–∏\n"
            "‚Ä¢ üíå –°–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –∑ –º–∞—Ç—á–∞–º–∏\n"
            "‚Ä¢ ‚öôÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å",
            reply_markup=ReplyKeyboardRemove()
        )
        await show_profile(update, context)
    else:
        await update.message.reply_text("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.")
    
    return ConversationHandler.END

async def cancel_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–∫–∞—Å—É–≤–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é"""
    await update.message.reply_text(
        "‚ùå –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ.",
        reply_markup=ReplyKeyboardRemove()
    )
    return ConversationHandler.END

async def show_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"""
    user = update.effective_user
    user_data, is_complete = db.get_user_profile(user.id)
    
    if not user_data or not is_complete:
        await update.message.reply_text(
            "üìù –í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å —â–µ –Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π. –î–∞–≤–∞–π—Ç–µ —Å—Ç–≤–æ—Ä–∏–º–æ –π–æ–≥–æ!",
            reply_markup=ReplyKeyboardRemove()
        )
        await start_profile_creation(update, context)
        return
    
    # –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ—ñ–ª—é
    profile_text = (
        f"üë§ <b>–í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å</b>\n\n"
        f"üÜî ID: {user_data['telegram_id']}\n"
        f"üë§ –Ü–º'—è: {user_data['first_name']}\n"
        f"üìÖ –í—ñ–∫: {user_data['age']}\n"
        f"üéØ –°—Ç–∞—Ç—å: {'üë® –ß–æ–ª–æ–≤—ñ–∫' if user_data['gender'] == 'male' else 'üë© –ñ—ñ–Ω–∫–∞'}\n"
        f"üèôÔ∏è –ú—ñ—Å—Ç–æ: {user_data['city']}\n"
        f"üîç –®—É–∫–∞—é: {get_seeking_text(user_data['seeking_gender'])}\n"
        f"üéØ –¶—ñ–ª—å: {user_data['goal']}\n"
        f"üìñ –ü—Ä–æ —Å–µ–±–µ: {user_data['bio']}\n\n"
        f"‚≠ê –†–µ–π—Ç–∏–Ω–≥: {user_data['rating']}/10\n"
        f"‚ù§Ô∏è –õ–∞–π–∫—ñ–≤: {user_data['likes_count']}\n"
    )
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ–æ—Ç–æ
    photos = db.get_profile_photos(user.id)
    if photos:
        # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ñ–æ—Ç–æ –∑ –æ–ø–∏—Å–æ–º
        await update.message.reply_photo(
            photo=photos[0],
            caption=profile_text,
            parse_mode='HTML'
        )
    else:
        await update.message.reply_text(
            profile_text,
            parse_mode='HTML'
        )

def get_seeking_text(seeking_gender):
    """–û—Ç—Ä–∏–º–∞—Ç–∏ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—à—É–∫—É"""
    if seeking_gender == 'male':
        return 'üë® –ß–æ–ª–æ–≤—ñ–∫—ñ–≤'
    elif seeking_gender == 'female':
        return 'üë© –ñ—ñ–Ω–æ–∫'
    else:
        return 'üë´ –í—Å—ñ—Ö'

# ==================== –û–°–ù–û–í–ù–Ü –ö–û–ú–ê–ù–î–ò ====================

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    help_text = (
        "ü§ñ <b>Chatrix Bot - –î–æ–≤—ñ–¥–∫–∞</b>\n\n"
        "üìã <b>–û—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:</b>\n"
        "/start - –ü–æ—á–∞—Ç–æ–∫ —Ä–æ–±–æ—Ç–∏ —Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é\n"
        "/profile - –ü–µ—Ä–µ–≥–ª—è–¥ —Ç–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é\n"
        "/search - –ü–æ—à—É–∫ –∞–Ω–∫–µ—Ç\n"
        "/likes - –ü–µ—Ä–µ–≥–ª—è–¥ –ª–∞–π–∫—ñ–≤\n"
        "/matches - –í–∞—à—ñ –º–∞—Ç—á—ñ\n"
        "/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        "/help - –¶—è –¥–æ–≤—ñ–¥–∫–∞\n\n"
        "üí° <b>–Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è:</b>\n"
        "1. –°—Ç–≤–æ—Ä—ñ—Ç—å –ø—Ä–æ—Ñ—ñ–ª—å (/start)\n"
        "2. –ü–µ—Ä–µ–≥–ª—è–¥–∞–π—Ç–µ –∞–Ω–∫–µ—Ç–∏ (/search)\n"
        "3. –°—Ç–∞–≤—Ç–µ –ª–∞–π–∫–∏ ‚ù§Ô∏è\n"
        "4. –°–ø—ñ–ª–∫—É–π—Ç–µ—Å—è –∑ –º–∞—Ç—á–∞–º–∏ üíå\n\n"
        "‚öôÔ∏è –î–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤: /admin"
    )
    await update.message.reply_text(help_text, parse_mode='HTML')

async def profile_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /profile"""
    await show_profile(update, context)

# ==================== –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–ú–ò–õ–û–ö ====================

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫"""
    logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ –±–æ—Ç—ñ: {context.error}", exc_info=True)

# ==================== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –û–ë–†–û–ë–ù–ò–ö–Ü–í ====================

def setup_handlers(app):
    """–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤"""
    
    # ConversationHandler –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
    profile_conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start_profile_creation)],
        states={
            PROFILE_AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, profile_age)],
            PROFILE_GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, profile_gender)],
            PROFILE_CITY: [MessageHandler(filters.TEXT & ~filters.COMMAND, profile_city)],
            PROFILE_SEEKING_GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, profile_seeking_gender)],
            PROFILE_GOAL: [MessageHandler(filters.TEXT & ~filters.COMMAND, profile_goal)],
            PROFILE_BIO: [MessageHandler(filters.TEXT & ~filters.COMMAND, profile_bio)],
        },
        fallbacks=[CommandHandler('cancel', cancel_profile)]
    )
    
    # –û—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–∞–Ω–¥–∏
    app.add_handler(profile_conv_handler)
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("profile", profile_command))
    
    # –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫
    app.add_error_handler(error_handler)

# ==================== –£–ü–†–ê–í–õ–Ü–ù–ù–Ø EVENT LOOP ====================

async def shutdown(signal, loop):
    """–ö–æ—Ä–µ–∫—Ç–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏"""
    logger.info(f"üîÑ –û—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª {signal.name}...")
    global application
    
    if application:
        logger.info("üîÑ –ó—É–ø–∏–Ω–∫–∞ –±–æ—Ç–∞...")
        await application.stop()
        await application.shutdown()
        logger.info("‚úÖ –ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–æ")
    
    logger.info("üîÑ –ó—É–ø–∏–Ω–∫–∞ event loop...")
    loop.stop()

# ==================== –ó–ê–ü–£–°–ö –ë–û–¢–ê ====================

async def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    global application
    
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ Chatrix Bot...")
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
    import requests
    try:
        response = requests.get(f"https://api.telegram.org/bot{TOKEN}/getMe", timeout=10)
        if response.json().get('ok'):
            bot_info = response.json()['result']
            logger.info(f"‚úÖ –ë–æ—Ç –∑–Ω–∞–π–¥–µ–Ω–∏–π: {bot_info['first_name']}")
        else:
            logger.error("‚ùå –ë–æ—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–æ–∫–µ–Ω.")
            return
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±–æ—Ç–∞: {e}")
        return
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ –¥–æ–¥–∞—Ç–æ–∫
    application = Application.builder().token(TOKEN).build()
    
    # –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏
    setup_handlers(application)
    
    # –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –æ–±—Ä–æ–±–∫—É —Å–∏–≥–Ω–∞–ª—ñ–≤
    loop = asyncio.get_event_loop()
    signals = (signal.SIGTERM, signal.SIGINT)
    for s in signals:
        loop.add_signal_handler(
            s, lambda s=s: asyncio.create_task(shutdown(s, loop))
        )
    
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–æ–ª—ñ–Ω–≥
    logger.info("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ä–µ–∂–∏–º—ñ –ø–æ–ª—ñ–Ω–≥—É")
    await application.run_polling(
        allowed_updates=Update.ALL_TYPES,
        drop_pending_updates=True
    )

if __name__ == '__main__':
    try:
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ uvloop –¥–ª—è –∫—Ä–∞—â–æ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (—è–∫—â–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)
        try:
            import uvloop
            uvloop.install()
            logger.info("‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è uvloop")
        except ImportError:
            logger.info("‚ÑπÔ∏è uvloop –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π asyncio")
        
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("‚èπÔ∏è –ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º")
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}")
        sys.exit(1)